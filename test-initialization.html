<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Initialization Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .warning { background: #fff3cd; color: #856404; }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
      font-size: 12px;
    }
    h3 { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Chain System Initialization Test</h1>
  
  <h3>1. Module Loading</h3>
  <div id="moduleStatus" class="status info">Checking modules...</div>
  
  <h3>2. Chain Manager</h3>
  <div id="chainStatus" class="status info">Checking chain manager...</div>
  
  <h3>3. Configuration Values</h3>
  <div id="configStatus" class="status info">Checking configuration...</div>
  <pre id="configDetails"></pre>
  
  <h3>4. Storage System</h3>
  <div id="storageStatus" class="status info">Checking storage...</div>
  
  <h3>5. Variable Initialization</h3>
  <div id="varStatus" class="status info">Checking variables...</div>
  <pre id="varDetails"></pre>
  
  <h3>6. VMU Chart</h3>
  <div id="vmuStatus" class="status info">Checking VMU chart...</div>
  
  <script type="module">
    async function runTests() {
      const results = {};
      
      // Test 1: Module Loading
      try {
        const { chainManager } = await import('./js/config/chainConfig.js');
        const { chainStorage } = await import('./js/utils/chainStorageUtils.js');
        
        window.chainManager = chainManager;
        window.chainStorage = chainStorage;
        
        document.getElementById('moduleStatus').className = 'status success';
        document.getElementById('moduleStatus').textContent = '✅ Modules loaded successfully';
        results.modules = 'success';
      } catch (e) {
        document.getElementById('moduleStatus').className = 'status error';
        document.getElementById('moduleStatus').textContent = `❌ Module loading failed: ${e.message}`;
        results.modules = 'failed';
      }
      
      // Test 2: Chain Manager
      try {
        const currentChain = window.chainManager.getCurrentChain();
        const config = window.chainManager.getCurrentConfig();
        
        document.getElementById('chainStatus').className = 'status success';
        document.getElementById('chainStatus').textContent = `✅ Chain Manager active - Current chain: ${currentChain}`;
        results.chainManager = 'success';
      } catch (e) {
        document.getElementById('chainStatus').className = 'status error';
        document.getElementById('chainStatus').textContent = `❌ Chain Manager error: ${e.message}`;
        results.chainManager = 'failed';
      }
      
      // Test 3: Configuration Values
      try {
        const config = window.chainManager.getCurrentConfig();
        const configData = {
          chain: window.chainManager.getCurrentChain(),
          chainId: config.id,
          contracts: {
            XEN_CRYPTO: config.contracts.XEN_CRYPTO,
            COINTOOL: config.contracts.COINTOOL,
            XENFT_TORRENT: config.contracts.XENFT_TORRENT,
            XENFT_STAKE: config.contracts.XENFT_STAKE
          },
          explorer: config.explorer.name,
          databases: {
            cointool: window.chainManager.getDatabaseName('cointool'),
            xenft: window.chainManager.getDatabaseName('xenft')
          }
        };
        
        document.getElementById('configStatus').className = 'status success';
        document.getElementById('configStatus').textContent = '✅ Configuration loaded';
        document.getElementById('configDetails').textContent = JSON.stringify(configData, null, 2);
        results.config = 'success';
      } catch (e) {
        document.getElementById('configStatus').className = 'status error';
        document.getElementById('configStatus').textContent = `❌ Configuration error: ${e.message}`;
        results.config = 'failed';
      }
      
      // Test 4: Storage System
      try {
        // Test storage operations
        window.chainStorage.setItem('test_key', 'test_value');
        const retrieved = window.chainStorage.getItem('test_key');
        window.chainStorage.removeItem('test_key');
        
        // Test global vs chain-specific
        localStorage.setItem('etherscanApiKey', 'TEST_API_KEY');
        const apiKey = localStorage.getItem('etherscanApiKey');
        
        document.getElementById('storageStatus').className = 'status success';
        document.getElementById('storageStatus').textContent = '✅ Storage system working';
        results.storage = 'success';
      } catch (e) {
        document.getElementById('storageStatus').className = 'status error';
        document.getElementById('storageStatus').textContent = `❌ Storage error: ${e.message}`;
        results.storage = 'failed';
      }
      
      // Test 5: Variable Initialization (simulating main_app.js variables)
      try {
        // Simulate the getChainConfig function
        const getChainConfig = () => {
          if (window.chainManager) {
            try {
              return window.chainManager.getCurrentConfig();
            } catch (e) {
              console.debug('Chain manager not ready, using defaults');
            }
          }
          return {
            rpcUrls: { default: 'https://ethereum-rpc.publicnode.com' },
            contracts: {
              COINTOOL: "0x0dE8bf93dA2f7eecb3d9169422413A9bef4ef628",
              XEN_CRYPTO: '0x06450dee7fd2fb8e39061434babcfc05599a6fb8'
            },
            events: {
              COINTOOL_MINT_TOPIC: "0xe9149e1b5059238baed02fa659dbf4bd932fbcf760a431330df4d934bc942f37",
              REMINT_SELECTOR: '0xc2580804'
            },
            constants: {
              SALT_BYTES_TO_QUERY: '0x01'
            }
          };
        };
        
        const config = getChainConfig();
        const varData = {
          DEFAULT_RPC: config.rpcUrls.default,
          CONTRACT_ADDRESS: config.contracts.COINTOOL,
          XEN_CRYPTO_ADDRESS: config.contracts.XEN_CRYPTO,
          EVENT_TOPIC: config.events.COINTOOL_MINT_TOPIC,
          CHAIN_ID: config.id || 1
        };
        
        document.getElementById('varStatus').className = 'status success';
        document.getElementById('varStatus').textContent = '✅ Variables initialized correctly';
        document.getElementById('varDetails').textContent = JSON.stringify(varData, null, 2);
        results.variables = 'success';
      } catch (e) {
        document.getElementById('varStatus').className = 'status error';
        document.getElementById('varStatus').textContent = `❌ Variable initialization error: ${e.message}`;
        results.variables = 'failed';
      }
      
      // Test 6: VMU Chart
      try {
        // Simulate vmuChart initialization
        let vmuChart = null;
        window.vmuChart = vmuChart;
        
        // Test the updateVmuChart function logic
        function testUpdateVmuChart() {
          if (typeof vmuChart === 'undefined' || (!vmuChart && !window.vmuChart)) {
            // Would initialize here
            return 'needs_init';
          }
          if (!vmuChart && !window.vmuChart) return 'no_chart';
          return 'ready';
        }
        
        const chartStatus = testUpdateVmuChart();
        
        document.getElementById('vmuStatus').className = 'status success';
        document.getElementById('vmuStatus').textContent = `✅ VMU Chart check passed (status: ${chartStatus})`;
        results.vmuChart = 'success';
      } catch (e) {
        document.getElementById('vmuStatus').className = 'status warning';
        document.getElementById('vmuStatus').textContent = `⚠️ VMU Chart warning: ${e.message}`;
        results.vmuChart = 'warning';
      }
      
      // Summary
      const allSuccess = Object.values(results).every(r => r === 'success');
      if (allSuccess) {
        document.body.insertAdjacentHTML('beforeend', 
          '<h2 style="color: green;">✅ All systems operational!</h2>');
      } else {
        document.body.insertAdjacentHTML('beforeend', 
          '<h2 style="color: orange;">⚠️ Some issues detected - check details above</h2>');
      }
    }
    
    // Run tests when DOM is ready
    document.addEventListener('DOMContentLoaded', runTests);
  </script>
</body>
</html>