<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Migration & Auto-Switching</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    .info { color: blue; }
    .warning { color: orange; }
  </style>
</head>
<body>
  <h1>Migration & Auto-Switching Test</h1>
  
  <div class="test-section">
    <h3>1. Setup Test Data (Old Format)</h3>
    <button onclick="setupOldData()">Setup Old Format Data</button>
    <button onclick="clearAllData()">Clear All Data</button>
    <pre id="setupResult"></pre>
  </div>

  <div class="test-section">
    <h3>2. Test Migration</h3>
    <button onclick="testMigration()">Run Migration</button>
    <pre id="migrationResult"></pre>
  </div>

  <div class="test-section">
    <h3>3. Check Current Storage</h3>
    <button onclick="checkStorage()">Check Storage</button>
    <pre id="storageResult"></pre>
  </div>

  <div class="test-section">
    <h3>4. Test Auto Wallet Switching</h3>
    <button onclick="testWalletSwitch('ETHEREUM')">Switch to Ethereum</button>
    <button onclick="testWalletSwitch('BASE')">Switch to Base</button>
    <div id="walletResult"></div>
  </div>

  <div class="test-section">
    <h3>5. Test Address Loading</h3>
    <button onclick="testAddressLoading()">Test Address Loading</button>
    <pre id="addressResult"></pre>
  </div>

  <script type="module">
    import { chainManager, SUPPORTED_CHAINS } from './js/config/chainConfig.js';
    import { chainStorage } from './js/utils/chainStorageUtils.js';
    import { migrateOldLocalStorage, isMigrationNeeded } from './js/utils/migrationUtils.js';
    import { networkSelector } from './js/ui/networkSelector.js';
    
    window.chainManager = chainManager;
    window.chainStorage = chainStorage;
    window.networkSelector = networkSelector;
    
    // 1. Setup old format data
    window.setupOldData = function() {
      // Clear migration flag first
      localStorage.removeItem('migrationCompleted');
      
      // Set up old format data
      localStorage.setItem('ethAddress', '0xOLD1234567890abcdef\\n0xOLD9876543210fedcba');
      localStorage.setItem('customRPC', 'https://old-rpc-1.example.com\\nhttps://old-rpc-2.example.com');
      localStorage.setItem('etherscanApiKey', 'OLD_API_KEY_12345');
      localStorage.setItem('chunkSize', '1000');
      localStorage.setItem('startBlock', '17000000');
      localStorage.setItem('endBlock', '18000000');
      
      const result = {
        message: 'Old format data setup complete',
        data: {
          ethAddress: localStorage.getItem('ethAddress'),
          customRPC: localStorage.getItem('customRPC'),
          etherscanApiKey: localStorage.getItem('etherscanApiKey'),
          chunkSize: localStorage.getItem('chunkSize'),
          startBlock: localStorage.getItem('startBlock'),
          endBlock: localStorage.getItem('endBlock')
        }
      };
      
      document.getElementById('setupResult').textContent = JSON.stringify(result, null, 2);
    };
    
    // Clear all data
    window.clearAllData = function() {
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        keysToRemove.push(localStorage.key(i));
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      document.getElementById('setupResult').textContent = 'All localStorage cleared';
    };
    
    // 2. Test migration
    window.testMigration = function() {
      const needsMigration = isMigrationNeeded();
      const results = migrateOldLocalStorage();
      
      const output = {
        needsMigration,
        migrationResults: results,
        afterMigration: {
          ETHEREUM_ethAddress: localStorage.getItem('ETHEREUM_ethAddress'),
          ETHEREUM_customRPC: localStorage.getItem('ETHEREUM_customRPC'),
          etherscanApiKey: localStorage.getItem('etherscanApiKey'),
          oldEthAddress: localStorage.getItem('ethAddress'),
          oldCustomRPC: localStorage.getItem('customRPC')
        }
      };
      
      document.getElementById('migrationResult').textContent = JSON.stringify(output, null, 2);
    };
    
    // 3. Check storage
    window.checkStorage = function() {
      const storage = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        storage[key] = localStorage.getItem(key);
      }
      
      const categorized = {
        ethereum: {},
        base: {},
        global: {},
        other: {}
      };
      
      Object.entries(storage).forEach(([key, value]) => {
        if (key.startsWith('ETHEREUM_')) {
          categorized.ethereum[key] = value;
        } else if (key.startsWith('BASE_')) {
          categorized.base[key] = value;
        } else if (['etherscanApiKey', 'theme', 'selectedChain', 'migrationCompleted'].includes(key)) {
          categorized.global[key] = value;
        } else {
          categorized.other[key] = value;
        }
      });
      
      document.getElementById('storageResult').textContent = JSON.stringify(categorized, null, 2);
    };
    
    // 4. Test wallet switching
    window.testWalletSwitch = async function(chain) {
      const resultDiv = document.getElementById('walletResult');
      
      if (!window.ethereum) {
        resultDiv.innerHTML = '<span class="error">No wallet detected</span>';
        return;
      }
      
      try {
        const config = SUPPORTED_CHAINS[chain];
        const chainId = '0x' + config.id.toString(16);
        
        resultDiv.innerHTML = `<span class="info">Switching to ${config.name}...</span>`;
        
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId }],
        });
        
        resultDiv.innerHTML = `<span class="success">✅ Successfully switched to ${config.name}</span>`;
      } catch (error) {
        if (error.code === 4902) {
          resultDiv.innerHTML = '<span class="warning">Chain not added to wallet. Trying to add...</span>';
          
          try {
            const config = SUPPORTED_CHAINS[chain];
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: '0x' + config.id.toString(16),
                chainName: config.name,
                nativeCurrency: config.nativeCurrency,
                rpcUrls: [config.rpcUrls.default],
                blockExplorerUrls: [config.explorer.baseUrl]
              }],
            });
            resultDiv.innerHTML = `<span class="success">✅ Added and switched to ${config.name}</span>`;
          } catch (addError) {
            resultDiv.innerHTML = `<span class="error">❌ Failed to add chain: ${addError.message}</span>`;
          }
        } else {
          resultDiv.innerHTML = `<span class="error">❌ Failed to switch: ${error.message}</span>`;
        }
      }
    };
    
    // 5. Test address loading
    window.testAddressLoading = function() {
      const tests = [];
      
      // Test Ethereum loading
      chainManager.setChain('ETHEREUM');
      let ethAddresses = chainStorage.getItem('ethAddress');
      if (!ethAddresses) {
        ethAddresses = localStorage.getItem('ETHEREUM_ethAddress') || localStorage.getItem('ethAddress') || '';
      }
      tests.push(`Ethereum addresses: ${ethAddresses || 'none'}`);
      
      // Test Base loading
      chainManager.setChain('BASE');
      let baseAddresses = chainStorage.getItem('ethAddress');
      if (!baseAddresses) {
        const baseLoadedKey = 'BASE_addresses_loaded';
        if (!localStorage.getItem(baseLoadedKey)) {
          baseAddresses = localStorage.getItem('ETHEREUM_ethAddress') || '';
          tests.push('Base would load from Ethereum (first time)');
        } else {
          tests.push('Base has been loaded before');
        }
      }
      tests.push(`Base addresses: ${baseAddresses || 'none'}`);
      
      document.getElementById('addressResult').textContent = tests.join('\\n');
    };
    
    // Auto-check on load
    document.addEventListener('DOMContentLoaded', () => {
      checkStorage();
    });
  </script>
</body>
</html>