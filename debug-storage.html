<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Storage Issues</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    button { margin: 5px; padding: 8px 15px; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>Storage Debug Tool</h1>
  
  <div class="section">
    <h3>1. Check localStorage for addresses</h3>
    <button onclick="checkLocalStorage()">Check localStorage</button>
    <pre id="localStorageResult"></pre>
  </div>

  <div class="section">
    <h3>2. Check chainManager initialization</h3>
    <button onclick="checkChainManager()">Check Chain Manager</button>
    <pre id="chainManagerResult"></pre>
  </div>

  <div class="section">
    <h3>3. Test address loading logic</h3>
    <button onclick="testAddressLoading()">Test Address Loading</button>
    <pre id="addressLoadingResult"></pre>
  </div>

  <div class="section">
    <h3>4. Migrate old data to new format</h3>
    <button onclick="migrateOldData()">Migrate Old Data</button>
    <pre id="migrationResult"></pre>
  </div>

  <script type="module">
    import { chainManager } from './js/config/chainConfig.js';
    import { chainStorage } from './js/utils/chainStorageUtils.js';
    
    window.chainManager = chainManager;
    window.chainStorage = chainStorage;
    
    window.checkLocalStorage = function() {
      const result = {
        allKeys: [],
        addressKeys: {},
        rpcKeys: {},
        apiKey: localStorage.getItem('etherscanApiKey')
      };
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        result.allKeys.push(key);
        
        if (key.includes('ethAddress')) {
          result.addressKeys[key] = localStorage.getItem(key);
        }
        if (key.includes('customRPC')) {
          result.rpcKeys[key] = localStorage.getItem(key);
        }
      }
      
      // Check for old format
      if (localStorage.getItem('ethAddress')) {
        result.oldFormatAddress = localStorage.getItem('ethAddress');
      }
      
      document.getElementById('localStorageResult').textContent = JSON.stringify(result, null, 2);
    };
    
    window.checkChainManager = function() {
      try {
        const result = {
          initialized: !!chainManager,
          currentChain: chainManager.getCurrentChain(),
          currentConfig: {
            name: chainManager.getCurrentConfig().name,
            id: chainManager.getCurrentConfig().id
          },
          storageKey: chainManager.getStorageKey('ethAddress'),
          databaseName: chainManager.getDatabaseName('cointool')
        };
        
        document.getElementById('chainManagerResult').textContent = JSON.stringify(result, null, 2);
      } catch (e) {
        document.getElementById('chainManagerResult').textContent = 'Error: ' + e.message;
      }
    };
    
    window.testAddressLoading = function() {
      const results = [];
      
      // Test 1: Direct chainStorage access
      const directAccess = chainStorage.getItem('ethAddress');
      results.push(`Direct chainStorage.getItem('ethAddress'): ${directAccess || 'null'}`);
      
      // Test 2: Check what key is being used
      const currentChain = chainManager.getCurrentChain();
      const expectedKey = `${currentChain}_ethAddress`;
      results.push(`Expected key: ${expectedKey}`);
      results.push(`Value at expected key: ${localStorage.getItem(expectedKey) || 'null'}`);
      
      // Test 3: Check if old format exists
      const oldFormat = localStorage.getItem('ethAddress');
      if (oldFormat) {
        results.push(`\nOLD FORMAT FOUND: ${oldFormat}`);
        results.push('This needs to be migrated to chain-specific format!');
      }
      
      // Test 4: Try the actual loading logic from main_app.js
      let addresses = "";
      if (window.chainStorage && window.chainManager) {
        const currentChain = window.chainManager.getCurrentChain();
        addresses = window.chainStorage.getItem("ethAddress") || "";
        
        if (!addresses && currentChain === 'BASE') {
          const baseLoadedKey = 'BASE_addresses_loaded';
          if (!localStorage.getItem(baseLoadedKey)) {
            addresses = localStorage.getItem("ETHEREUM_ethAddress") || "";
          }
        }
      }
      results.push(`\nLoading logic result: ${addresses || 'empty'}`);
      
      document.getElementById('addressLoadingResult').textContent = results.join('\n');
    };
    
    window.migrateOldData = function() {
      const results = [];
      
      // Check for old format data
      const oldAddress = localStorage.getItem('ethAddress');
      const oldRPC = localStorage.getItem('customRPC');
      
      if (oldAddress) {
        // Save to Ethereum-specific key
        localStorage.setItem('ETHEREUM_ethAddress', oldAddress);
        results.push(`✅ Migrated addresses to ETHEREUM_ethAddress: ${oldAddress.substring(0, 50)}...`);
        
        // Remove old key
        localStorage.removeItem('ethAddress');
        results.push('✅ Removed old ethAddress key');
      } else {
        results.push('ℹ️ No old ethAddress found to migrate');
      }
      
      if (oldRPC) {
        // Save to Ethereum-specific key
        localStorage.setItem('ETHEREUM_customRPC', oldRPC);
        results.push(`✅ Migrated RPC to ETHEREUM_customRPC: ${oldRPC.substring(0, 50)}...`);
        
        // Remove old key
        localStorage.removeItem('customRPC');
        results.push('✅ Removed old customRPC key');
      } else {
        results.push('ℹ️ No old customRPC found to migrate');
      }
      
      // Clear the Base first-load flag to allow re-copying from Ethereum
      localStorage.removeItem('BASE_addresses_loaded');
      results.push('✅ Cleared BASE_addresses_loaded flag');
      
      results.push('\n🎉 Migration complete! Refresh the main page to see the changes.');
      
      document.getElementById('migrationResult').textContent = results.join('\n');
    };
    
    // Auto-run checks on load
    document.addEventListener('DOMContentLoaded', () => {
      checkLocalStorage();
      checkChainManager();
      testAddressLoading();
    });
  </script>
</body>
</html>